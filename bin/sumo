#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/sumo'

require 'thor'

class CLI < Thor
	desc "launch", "launch an instance"
	def launch
		id = task("Launching instance") { sumo.launch }
		host = task("Acquiring hostname") { sumo.wait_for_hostname(id) }

		puts "\nLogging you in via ssh.  Type 'exit' or Ctrl-D to return to your local system."
		puts '-' * 78

		connect_ssh(host)
	end

	desc "ssh [<instance_id or hostname>]", "ssh to a specified instance or first available"
	def ssh(id=nil)
		inst = sumo.find(id) || sumo.running.first || abort("No running instances")
		hostname = inst[:hostname] || wait_for_hostname(inst[:instance_id])
		connect_ssh hostname
	end

	desc "bootstrap", "bootstrap chef and cookbooks"
	def bootstrap(id=nil)
		inst = sumo.find(id) || sumo.running.first || abort("No running instances")

		commands = [
			'apt-get update',
			'apt-get install -y ruby',
			'apt-get install -y ruby-dev',
			'apt-get install -y rubygems',
			'apt-get install -y git-core',
			'gem sources -a http://gems.opscode.com',
			'gem install chef ohai --no-rdoc --no-ri',
			"git clone #{sumo.config['cookbooks_url']}",
		]

		puts "---> Bootstrapping #{inst[:hostname]}"
		commands.each do |cmd|
			sumo.ssh(inst[:hostname], cmd)
		end
	end

	desc "role", "setup instance as a role"
	def role(role, id=nil)
		inst = sumo.find(id) || sumo.running.first || abort("No running instances")

		puts "---> Setting #{inst[:hostname]} to be #{role}"
		sumo.ssh(inst[:hostname], "cd chef-cookbooks && /var/lib/gems/1.8/bin/chef-solo -j roles/#{role}.json")
	end

	desc "list", "list running instances"
	def list
		sumo.list.each do |inst|
			printf "%-50s %-12s %s\n", inst[:hostname], inst[:instance_id], inst[:status]
		end
	end

	desc "terminate [<instance_id or hostname>]", "terminate specified instance or first available"
	def terminate(id=nil)
		inst = sumo.find(id) || (sumo.running | sumo.pending).first || abort("No running or pending instances")

		sumo.terminate(inst[:instance_id])
		puts "#{inst[:hostname] || inst[:instance_id]} scheduled for termination"
	end

	desc "terminate_all", "terminate all instances"
	def terminate_all
		instances = (sumo.running | sumo.pending)
		abort("No running or pending instances") if instances.empty?
		instances.each do |inst|
			sumo.terminate(inst[:instance_id])
			puts "#{inst[:hostname] || inst[:instance_id]} scheduled for termination"
		end
	end

	no_tasks do
		def sumo
			@sumo ||= Sumo.new
		end

		def task(msg, &block)
			printf "---> %-24s ", "#{msg}..."
			start = Time.now
			result = block.call || 'done'
			finish = Time.now
			time = sprintf("%0.1f", finish - start)
			puts "#{result} (#{time}s)"
			result
		end

		def connect_ssh(hostname)
			sumo.wait_for_ssh(hostname)

			system "ssh -i #{sumo.keypair_file} root@#{hostname}"
			if $?.success?
				puts "\nType 'sumo terminate' if you're done with this instance."
			end
		end
	end
end

CLI.start
